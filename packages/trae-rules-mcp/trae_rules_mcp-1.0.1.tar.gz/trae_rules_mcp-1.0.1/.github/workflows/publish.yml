name: ðŸš€ å‘å¸ƒåˆ° PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'å‘å¸ƒçŽ¯å¢ƒ'
        required: true
        default: 'testpypi'
        type: choice
        options:
        - testpypi
        - pypi

jobs:
  publish:
    name: ðŸ“¦ æž„å»ºå’Œå‘å¸ƒ
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'pypi' }}
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: ðŸ”§ å®‰è£…ä¾èµ–
      run: |
        uv sync
        uv add --dev build twine
    
    - name: ðŸ§¹ æ¸…ç†æž„å»ºæ–‡ä»¶
      run: rm -rf dist/ build/ *.egg-info/
    
    - name: ðŸ”¨ æž„å»ºåˆ†å‘åŒ…
      run: uv run python -m build
    
    - name: âœ… æ£€æŸ¥åˆ†å‘åŒ…
      run: uv run twine check dist/*
    
    - name: ðŸ“‹ æ˜¾ç¤ºæž„å»ºç»“æžœ
      run: |
        echo "ðŸ“¦ æž„å»ºçš„åˆ†å‘åŒ…:"
        ls -la dist/
        echo "ðŸ“Š åŒ…å¤§å°:"
        du -h dist/*
    
    - name: ðŸ§ª å‘å¸ƒåˆ° TestPyPI
      if: github.event.inputs.environment == 'testpypi' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'testpypi')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "ðŸ§ª å‘å¸ƒåˆ° TestPyPI..."
        uv run twine upload --repository testpypi dist/*
        echo "âœ… å·²å‘å¸ƒåˆ° TestPyPI!"
        echo "ðŸ”— æŸ¥çœ‹: https://test.pypi.org/project/trae-rules-mcp/"
    
    - name: ðŸš€ å‘å¸ƒåˆ° PyPI
      if: github.event_name == 'release' || (github.event.inputs.environment == 'pypi')
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ðŸš€ å‘å¸ƒåˆ°æ­£å¼ PyPI..."
        uv run twine upload dist/*
        echo "ðŸŽ‰ å·²å‘å¸ƒåˆ° PyPI!"
        echo "ðŸ”— æŸ¥çœ‹: https://pypi.org/project/trae-rules-mcp/"
    
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: dist/
        retention-days: 30
    
    - name: ðŸ“ åˆ›å»ºå‘å¸ƒæ€»ç»“
      run: |
        echo "## ðŸŽ‰ å‘å¸ƒå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: $(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')" >> $GITHUB_STEP_SUMMARY
        echo "- **Python ç‰ˆæœ¬**: 3.11" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ åˆ†å‘åŒ…" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la dist/ >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.environment }}" = "testpypi" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "### ðŸ§ª TestPyPI" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— [æŸ¥çœ‹åŒ…](https://test.pypi.org/project/trae-rules-mcp/)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ å®‰è£…: \`pip install --index-url https://test.pypi.org/simple/ trae-rules-mcp\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸš€ PyPI" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— [æŸ¥çœ‹åŒ…](https://pypi.org/project/trae-rules-mcp/)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ å®‰è£…: \`pip install trae-rules-mcp\`" >> $GITHUB_STEP_SUMMARY
        fi

  test-install:
    name: ðŸ§ª æµ‹è¯•å®‰è£…
    needs: publish
    runs-on: ubuntu-latest
    if: always() && needs.publish.result == 'success'
    
    steps:
    - name: ðŸ è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: â³ ç­‰å¾…åŒ…å¯ç”¨
      run: sleep 60  # ç­‰å¾…åŒ…åœ¨ PyPI ä¸Šå¯ç”¨
    
    - name: ðŸ“¦ æµ‹è¯•å®‰è£… (TestPyPI)
      if: github.event.inputs.environment == 'testpypi'
      run: |
        pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ trae-rules-mcp
        python -c "import main; print('âœ… TestPyPI å®‰è£…æµ‹è¯•æˆåŠŸ!')"
    
    - name: ðŸ“¦ æµ‹è¯•å®‰è£… (PyPI)
      if: github.event_name == 'release' || github.event.inputs.environment == 'pypi'
      run: |
        pip install trae-rules-mcp
        python -c "import main; print('âœ… PyPI å®‰è£…æµ‹è¯•æˆåŠŸ!')"
    
    - name: ðŸ“ æµ‹è¯•æ€»ç»“
      run: |
        echo "## âœ… å®‰è£…æµ‹è¯•å®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "åŒ…å·²æˆåŠŸå®‰è£…å¹¶å¯ä»¥æ­£å¸¸å¯¼å…¥ã€‚" >> $GITHUB_STEP_SUMMARY