<!--
    Derived from jupyter-remote-desktop-proxy, adapted for Firefox via Xpra
-->
<!doctype html>
<html lang="en">
  <head>
    <title>Firefox Browser via Xpra</title>

    <meta charset="utf-8" />

    <!-- Always force latest IE rendering engine (even in intranet) &
                Chrome Frame. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <style>
      /**
      Colors from https://github.com/jupyter/design/blob/main/brandguide/brand_guide.pdf
      **/
      html {
        --jupyter-main-brand-color: #f37626;
        --jupyter-dark-grey: #4d4d4d;
        --jupyter-medium-dark-grey: #616161;
        --jupyter-medium-grey: #757575;
        --jupyter-grey: #9e9e9e;

        --topbar-height: 32px;

        /* Use Jupyter Brand fonts */
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }

      body {
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: var(--jupyter-medium-dark-grey);
        margin: 0;
        padding: 0;
      }

      #top-bar {
        background-color: var(--jupyter-dark-grey);
        color: white;
        border-bottom: 1px white;
        display: flex;
        align-items: center;
        height: var(--topbar-height);
        padding: 0;
      }

      #logo {
        padding: 0 24px;
      }

      #logo img {
        height: 24px;
      }

      #menu {
        display: flex;
        font-weight: bold;
        margin-left: auto;
        font-size: 12px;
        list-style: none;
        margin: 0;
        padding: 0;
      }

      #menu li {
        border-right: 1px var(--jupyter-grey) solid;
        padding: 12px 0px;
      }

      #menu li:last-child {
        border-right: 0;
      }

      #menu a {
        color: white;
        text-decoration: none;
        padding: 12px 8px;
      }

      #menu a:hover,
      #menu a.active {
        background-color: var(--jupyter-medium-grey);
      }

      li#status-container {
        padding-right: 8px;
      }

      #status-label {
        font-weight: normal;
      }

      #screen {
        flex: 1;
        /* fill remaining space */
        overflow: hidden;
      }

      #screen iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: white;
        font-size: 18px;
      }
    </style>
  </head>

  <body>
    <div id="top-bar">
      <div id="logo">
        Firefox Browser
      </div>
      <ul id="menu">
        <li id="status-container">
          <span id="status-label">Status:</span>
          <span id="status">Loading...</span>
        </li>
        {% if hub_control_panel_url %}
        <li>
          <a href="{{ hub_control_panel_url }}">Hub Control Panel</a>
        </li>
        {% endif %}
      </ul>
    </div>
    <div id="screen">
      <div class="loading" id="loading">
        Starting Firefox browser via Xpra...
      </div>
      <iframe id="firefox-frame" src="{{ base_url }}proxy/firefox/" style="display: none;"
              onload="handleFrameLoad()">
      </iframe>
    </div>

    <script>
      // Retry loading if initial load fails
      let retryCount = 0;
      const maxRetries = 10;
      
      function handleFrameLoad() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('firefox-frame').style.display = 'block';
        document.getElementById('status').textContent = 'Ready';
      }
      
      function checkFrameLoaded() {
        const frame = document.getElementById('firefox-frame');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        
        try {
          // Try to access frame content to see if it loaded
          if (frame.contentDocument || frame.contentWindow) {
            handleFrameLoad();
            return;
          }
        } catch (e) {
          // Frame loaded but cross-origin, which means it worked
          handleFrameLoad();
          return;
        }
        
        // If we get here, frame didn't load properly
        if (retryCount < maxRetries) {
          retryCount++;
          status.textContent = `Retrying... (${retryCount}/${maxRetries})`;
          setTimeout(() => {
            frame.src = frame.src; // Reload frame
          }, 3000);
        } else {
          loading.innerHTML = 'Failed to load Firefox. <a href="{{ base_url }}proxy/firefox/" target="_blank" style="color: #f37626;">Click here to try directly</a>';
          status.textContent = 'Failed';
        }
      }
      
      // Initial check after a delay
      setTimeout(checkFrameLoaded, 5000);
      
      // Also try to detect load events
      document.getElementById('firefox-frame').addEventListener('load', () => {
        setTimeout(checkFrameLoaded, 1000);
      });
    </script>
  </body>
</html>
