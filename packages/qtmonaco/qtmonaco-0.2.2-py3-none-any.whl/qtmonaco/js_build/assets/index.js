var I=Object.defineProperty;var T=(l,e,t)=>e in l?I(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var d=(l,e,t)=>T(l,typeof e!="symbol"?e+"":e,t);import{l as w,e as b,P as R,S as L}from"./monaco-core.js";import{l as x}from"./vendor.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class _{constructor(e="localhost:1234"){d(this,"currentConnection",null);d(this,"reconnectAttempts",0);d(this,"baseReconnectDelay",1e3);d(this,"maxReconnectDelay",1e4);d(this,"providersRegistered",!1);d(this,"pylspUrl","localhost:1234");d(this,"providerDisposables",[]);d(this,"reconnectTimeoutId",null);d(this,"isDestroyed",!1);d(this,"healthCheckInterval",null);d(this,"webSocket",null);this.pylspUrl=e,this.connect()}connect(){if(this.isDestroyed){console.log("LSP client has been destroyed, skipping connection attempt");return}this.webSocket=new WebSocket("ws://"+this.pylspUrl);const e=this.webSocket;e.onopen=()=>{console.log("WebSocket connected"),this.reconnectAttempts=0},e.onerror=t=>{console.error("WebSocket error:",t)},e.onclose=t=>{if(console.log("WebSocket disconnected:",t.code,t.reason),this.currentConnection=null,this.stopHealthCheck(),this.isDestroyed){console.log("LSP client has been destroyed, skipping reconnection");return}this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null);const s=Math.min(this.baseReconnectDelay*Math.min(Math.pow(1.5,this.reconnectAttempts),10),this.maxReconnectDelay);this.reconnectAttempts++,console.log(`Attempting to reconnect in ${s}ms (attempt ${this.reconnectAttempts})`),this.reconnectTimeoutId=window.setTimeout(()=>{this.reconnectTimeoutId=null,this.connect()},s)},x({webSocket:e,onConnection:t=>{this.currentConnection=t,t.listen();const s={processId:null,rootUri:null,capabilities:{}};t.sendRequest("initialize",s).then(()=>{t.sendNotification("initialized",{}),console.log("LSP connection initialized successfully"),this.startHealthCheck()}).catch(n=>{console.error("Failed to initialize LSP:",n),this.currentConnection===t&&(this.currentConnection=null,t.dispose(),e.close())}),this.registerMonacoProviders()}})}registerMonacoProviders(){this.providersRegistered&&(console.log("Disposing existing Monaco providers before re-registering"),this.providerDisposables.forEach(n=>n.dispose()),this.providerDisposables=[],this.providersRegistered=!1);const e=w.registerCompletionItemProvider("python",{triggerCharacters:["."],provideCompletionItems:async(n,i)=>{const u=this.currentConnection;if(!this.isConnectionValid(u))return console.warn("No valid LSP connection available for completion"),{suggestions:[]};const r=u,m=n.uri.toString(),h=i.lineNumber-1,p=i.column-1;r.sendNotification("textDocument/didOpen",{textDocument:{uri:m,languageId:"python",version:1,text:n.getValue()}});try{const o=await r.sendRequest("textDocument/completion",{textDocument:{uri:m},position:{line:h,character:p},context:{triggerKind:1}});return{suggestions:(Array.isArray(o)?o:o.items).map(c=>({label:c.label,kind:w.CompletionItemKind.Function,insertText:c.insertText??c.label,documentation:c.documentation?typeof c.documentation=="string"?{value:c.documentation}:c.documentation:void 0,range:c.range}))}}catch(o){return console.error("LSP completion failed:",o),o instanceof Error&&(o.message.includes("disposed")||o.message.includes("closed"))&&(console.warn("Connection was disposed during completion request, forcing reconnection"),this.currentConnection=null,this.forceReconnect()),{suggestions:[]}}}}),t=w.registerSignatureHelpProvider("python",{signatureHelpTriggerCharacters:["(",",","="],provideSignatureHelp:async(n,i,u,r)=>{var C;const m=this.currentConnection;if(!this.isConnectionValid(m))return console.warn("No valid LSP connection available for signature help"),{value:{signatures:[],activeSignature:0,activeParameter:0},dispose:()=>{}};const h=m,p=n.uri.toString(),o=i.lineNumber-1,g=i.column-1;h.sendNotification("textDocument/didOpen",{textDocument:{uri:p,languageId:"python",version:1,text:n.getValue()}});try{const c=await h.sendRequest("textDocument/signatureHelp",{textDocument:{uri:p},position:{line:o,character:g},context:{triggerKind:r.triggerKind,triggerCharacter:r.triggerCharacter}});return!c||!((C=c.signatures)!=null&&C.length)?{value:{signatures:[],activeSignature:0,activeParameter:0},dispose:()=>{}}:{value:{signatures:c.signatures.map(v=>{var k;return{label:v.label,documentation:v.documentation?typeof v.documentation=="string"?{value:v.documentation}:v.documentation:void 0,parameters:((k=v.parameters)==null?void 0:k.map(f=>({label:typeof f.label=="string"?f.label:f.label[0]+"-"+f.label[1],documentation:f.documentation?typeof f.documentation=="string"?{value:f.documentation}:f.documentation:void 0})))||[]}}),activeSignature:c.activeSignature??0,activeParameter:c.activeParameter??0},dispose:()=>{}}}catch(c){return console.error("LSP signature help failed:",c),c instanceof Error&&(c.message.includes("disposed")||c.message.includes("closed"))&&(console.warn("Connection was disposed during signature help request, forcing reconnection"),this.currentConnection=null,this.forceReconnect()),{value:{signatures:[],activeSignature:0,activeParameter:0},dispose:()=>{}}}}}),s=w.registerHoverProvider("python",{provideHover:async(n,i)=>{const u=this.currentConnection;if(!this.isConnectionValid(u))return console.warn("No valid LSP connection available for hover"),null;const r=u,m=n.uri.toString(),h=i.lineNumber-1,p=i.column-1;r.sendNotification("textDocument/didOpen",{textDocument:{uri:m,languageId:"python",version:1,text:n.getValue()}});try{const o=await r.sendRequest("textDocument/hover",{textDocument:{uri:m},position:{line:h,character:p}});if(o!=null&&o.contents)return{contents:Array.isArray(o.contents)?o.contents.map(g=>({value:g.value||g})):[{value:o.contents.value||o.contents}],range:o.range}}catch(o){console.error("LSP hover failed:",o),o instanceof Error&&(o.message.includes("disposed")||o.message.includes("closed"))&&(console.warn("Connection was disposed during hover request, forcing reconnection"),this.currentConnection=null,this.forceReconnect())}return null}});this.providerDisposables.push(e,t,s),this.providersRegistered=!0,console.log("Monaco language providers registered successfully")}isConnectionValid(e){var t;if(!e)return!1;try{if(e._disposed||(t=e.isDisposed)!=null&&t.call(e))return console.warn("Detected disposed connection via disposal flags"),this.currentConnection===e&&(this.currentConnection=null,this.forceReconnect()),!1;const s=e.state||e._state;return s==="closed"||s==="disposed"||s===3?(console.warn("Detected closed connection via state check"),this.currentConnection===e&&(this.currentConnection=null,this.forceReconnect()),!1):!0}catch(s){return console.warn("Error checking connection validity, treating as invalid:",s),this.currentConnection===e&&(this.currentConnection=null,this.forceReconnect()),!1}}forceReconnect(){this.isDestroyed||(console.log("Forcing reconnection due to disposed connection"),this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.reconnectTimeoutId=window.setTimeout(()=>{this.reconnectTimeoutId=null,this.connect()},100))}startHealthCheck(){this.stopHealthCheck(),this.healthCheckInterval=window.setInterval(async()=>{var e;if(this.isDestroyed){this.stopHealthCheck();return}if(console.log("Status of the current connection: ",this.isConnected()?"Connected":"Disconnected"),this.currentConnection&&!this.isConnectionValid(this.currentConnection)){console.log("Health check detected invalid connection via basic checks");return}if(((e=this.webSocket)==null?void 0:e.readyState)!==WebSocket.OPEN){console.log("Health check detected invalid connection via WebSocket state"),this.forceReconnect();return}},5e3)}stopHealthCheck(){this.healthCheckInterval!==null&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null)}isConnected(){return this.isConnectionValid(this.currentConnection)}getConnection(){return this.currentConnection}setLspUrl(e){if(this.isDestroyed){console.warn("Cannot change URL: LSP client has been destroyed");return}console.log(`Changing LSP URL from ${this.pylspUrl} to ${e}`),this.pylspUrl=e,this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.currentConnection&&(this.currentConnection.dispose(),this.currentConnection=null),this.reconnectAttempts=0,this.connect()}destroy(){this.isDestroyed=!0,this.stopHealthCheck(),this.reconnectTimeoutId!==null&&(clearTimeout(this.reconnectTimeoutId),this.reconnectTimeoutId=null),this.providerDisposables.forEach(e=>e.dispose()),this.providerDisposables=[],this.providersRegistered=!1,this.currentConnection&&(this.currentConnection.dispose(),this.currentConnection=null),console.log("LSP client destroyed")}}const D=document.getElementById("container");if(!D)throw new Error("Container element not found");const a=b.create(D,{value:"",language:"python",automaticLayout:!0,theme:"vs-dark"});let S=null,P=null;function N(){console.log("Editor initialized"),y("bridge_initialized",!0)}window.onload=function(){console.log("Window loaded, initializing QWebChannel"),new QWebChannel(window.qt.webChannelTransport,function(l){S=l.objects.connector,S?(S.javascript_data_sent.connect(H),console.log("Successfully connected to javascript_data signal")):console.warn("Bridge javascript_data_sent.connect not available"),a.onDidChangeModelContent(e=>{const t=a.getModel();if(t){const s=t.getValue();y("_current_text",s)}}),N()})};function y(l,e){S&&S._receive(l,JSON.stringify(e))}function H(l,e){const t=JSON.parse(e);switch(console.log(`Received update from Python: ${l} =`,t),l){case"set_text":const s=a.getModel();s&&s.setValue(t);break;case"read":const n=a.getValue();y("_current_text",n);break;case"minimap":const i=t===!0;console.log(`Setting minimap enabled: ${i}`),a.updateOptions({minimap:{enabled:i}});break;case"set_cursor":{const r=t;if(a.getModel()){const h=r.line||1,p=r.column||1,o=r.moveToPosition||"",g=new R(h,p),C=new L(h,p,h,p);a.setPosition(g),a.setSelection(C),typeof o=="string"&&o&&(o==="center"?a.revealPositionInCenter(g):o==="top"?a.revealPositionNearTop(g,b.ScrollType.Smooth):a.revealPosition(g)),y("_current_cursor",{line:h,column:p})}break}case"readonly":const u=t===!0;a.updateOptions({readOnly:u});break;case"language":{const r=a.getModel();r&&b.setModelLanguage(r,t);break}case"theme":try{b.setTheme(t),console.log(`Applied theme: ${t}`),y("_theme",t)}catch(r){console.warn(`Failed to apply theme "${t}":`,r),b.setTheme("vs-dark"),y("_theme","vs-dark")}break;case"lsp_url":if(P&&(P.destroy(),P=null),t&&typeof t=="string"){const r=t;console.log(`Setting up LSP client with URL: ${r}`),P=new _(r)}break}}
