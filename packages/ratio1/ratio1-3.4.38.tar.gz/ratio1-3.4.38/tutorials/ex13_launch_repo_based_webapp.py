"""
ex13_launch_repo_based_webapp.py
-------------------------------

This script demonstrates how to create and deploy a webapp based on a public repository without using a specific
ngrok edge label. The script will create a webapp based on a public repository and deploy it to the
target Ratio1 Edge Node.
The webapp will be accessible via a temporary URL generated by the ngrok service.
The temporary URL will be retrieved and printed to the console.

"""
from os import environ
from ratio1 import Session


if __name__ == "__main__":
  session = Session()

  node = environ.get("EE_TARGET_NODE", "INSERT_YOUR_NODE_ADDRESS_HERE")

  session.wait_for_node(node)

  # This is optional!
  # If an ngrok edge label is provided, the webapp will be created using that label and
  # will have a permanent URL.
  # In case this is not provided by the user, a unique URL will be generated by the ngrok service.
  # Warning! create_webapp method does not support multiple nodes.
  ngrok_edge_label = environ.get("NGROK_EDGE_LABEL", None)

  # Defining the environment variables for the webapp.
  # Here we can pass anything we want to the webapp.
  env_vars = {
    'LOCAL_ADDRESS': '/edge_node/_local_cache/_data/local_info.json',
    "VAR_NAME_1": "value1",
    "VAR_NAME_2": "value2",
  }

  # Defining the webapp setup commands.
  setup_commands = [
    "npm install"
  ]

  # Defining the assets of the application.
  assets = {
    'operation': "clone",
    "url": "https://github.com/ratio1/demo-deploy-nodejs",
    # The below are only necessary for private repos
    "username": "<username>",
    "token": "<git_user_token>",
  }

  # Defining the webapp run commands.
  run_command = "npm start"

  # instance: PLUGIN_TYPES.CUSTOM_WEBAPI_01
  pipeline, instance = session.create_web_app(
    node=node,
    name="Ratio1_WebApp_tutorial",
    env_vars=env_vars,
    setup_commands=setup_commands,
    run_command=run_command,
    ngrok_edge_label=ngrok_edge_label,
    assets=assets
  )

  url = pipeline.deploy()

  # print the url of the webapp
  session.P(
    f"Webapp available at: {url}.\nNote that this url is temporary. "
    f"In case the node is restarted, a new url will be generated.\n"
    f"In case you see an ngrok gateway error please try again after a few seconds.",
    color='g', boxed=True, show=True
  )

  # Observation:
  #   next code is not mandatory - it is used to keep the session open and cleanup the resources
  #   in production, you would not need this code as the script can close after the pipeline will be sent
  session.run(
    wait=True,  # wait for the user to stop the execution
    close_pipelines=True  # when the user stops the execution, the remote edge-node pipelines will be closed
  )
